# =================== æ„å»ºé˜¶æ®µ ===================
FROM alpine:latest AS builder

WORKDIR /app
ENV TZ=Asia/Shanghai

# è·å–æ„å»ºå¹³å°ä¿¡æ¯
ARG TARGETOS
ARG TARGETARCH
ARG TARGETVARIANT

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /app/data && \
    mkdir -p /app/template && \
    mkdir -p /app/config

# ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„è·¯å¾„
COPY linux-amd64/ /tmp/linux-amd64/
COPY linux-arm64/ /tmp/linux-arm64/
COPY frontend/frontend.tar.gz /tmp/
COPY config/ /app/config/

# ğŸ”§ ä¿®å¤ï¼šè§£å‹å¯¹åº”å¹³å°çš„ clear äºŒè¿›åˆ¶
RUN if [ "$TARGETOS" = "linux" ] && [ "$TARGETARCH" = "amd64" ]; then \
       tar -xzf /tmp/linux-amd64/clear-linux-amd64.tar.gz -C /tmp && mv /tmp/clear /app/clear; \
    elif [ "$TARGETOS" = "linux" ] && [ "$TARGETARCH" = "arm64" ]; then \
       tar -xzf /tmp/linux-arm64/clear-linux-arm64.tar.gz -C /tmp && mv /tmp/clear /app/clear; \
    else \
       echo "Unsupported platform: $TARGETOS/$TARGETARCH$TARGETVARIANT" && exit 1; \
    fi && \
    # è§£å‹å‰ç«¯é™æ€èµ„æºåˆ° /app/template
    tar -xzf /tmp/frontend.tar.gz -C /app/template && \
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf /tmp/*

# =================== æœ€ç»ˆé•œåƒ ===================
FROM alpine:latest

WORKDIR /app
ENV TZ=Asia/Shanghai

# å®‰è£…è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache ca-certificates tzdata

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder /app /app

# éªŒè¯æ–‡ä»¶
RUN ls -lh /app

# è®¾ç½® clear äºŒè¿›åˆ¶æ–‡ä»¶çš„æƒé™
RUN chmod +x /app/clear

# åˆ›å»ºæ•°æ®ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app/data && chmod -R 777 /app/data

# æš´éœ²ç«¯å£
EXPOSE 6633

# è¿è¡Œåç«¯æœåŠ¡
CMD ["/app/clear"]